package raster

import "bytes"

// Each byte has 7 bits set to 1 and 1 bit set to 0 (random position)
var CUTLINE = []byte{
	0xDF, 0x7F, 0xFB, 0xF7, 0xBF, 0xEF, 0xFD, 0xFE, 0xF7, 0xDF, 0x7F, 0xFB, 0xEF, 0xBF, 0xFE, 0xFD,
	0xFB, 0xF7, 0xDF, 0x7F, 0xBF, 0xEF, 0xFD, 0xFE, 0xF7, 0xDF, 0x7F, 0xFB, 0xEF, 0xBF, 0xFE, 0xFD,
	0xFE, 0xBF, 0xDF, 0x7F, 0xF7, 0xFB, 0xEF, 0xFD, 0x7F, 0xDF, 0xFB, 0xF7, 0xBF, 0xEF, 0xFE, 0xFD,
	0xF7, 0xFB, 0xDF, 0x7F, 0xBF, 0xEF, 0xFD, 0xFE, 0xFB, 0xF7, 0xDF, 0x7F, 0xEF, 0xBF, 0xFE, 0xFD,
	0xFD, 0xEF, 0xBF, 0x7F, 0xF7, 0xDF, 0xFB, 0xFE, 0xBF, 0xEF, 0x7F, 0xDF, 0xFB, 0xF7, 0xFE, 0xFD,
	0xEF, 0xBF, 0xDF, 0x7F, 0xF7, 0xFB, 0xFE, 0xFD, 0x7F, 0xDF, 0xFB, 0xF7, 0xBF, 0xEF, 0xFD, 0xFE,
	0xF7, 0xFB, 0xDF, 0x7F, 0xBF, 0xEF, 0xFE, 0xFD, 0xFB, 0xF7, 0xDF, 0x7F, 0xEF, 0xBF, 0xFE, 0xFD,
	0xFE, 0xBF, 0xDF, 0x7F, 0xF7, 0xFB, 0xEF, 0xFD, 0x7F, 0xDF, 0xFB, 0xF7, 0xBF, 0xEF, 0xFD, 0xFE,
}

// 在图像底部添加一行切割线
func (img *RasterImage) WithCutline() *RasterImage {
	if img == nil || img.Content == nil || img.Width <= 0 || img.Height <= 0 {
		return nil
	}

	// 确保宽度是8的倍数
	width := img.Width
	if width%8 != 0 {
		width = (width/8 + 1) * 8
	}

	bytesPerRow := width / 8
	cutline := make([]byte, bytesPerRow)
	copy(cutline, CUTLINE)

	// 复制原内容
	newContent := make([]byte, len(img.Content))
	copy(newContent, img.Content)
	newContent = append(newContent, cutline...)

	return &RasterImage{
		Width:   width,
		Height:  img.Height + 1,
		Content: newContent,
	}
}

func isCutline(line []byte) bool {
	if len(line) > len(CUTLINE) {
		return false
	}
	return bytes.Equal(line, CUTLINE[:len(line)])
}

func (img *RasterImage) CutPages() []*RasterImage {
	var pages []*RasterImage
	var cutLines []int

	for i := range img.Height {
		row := img.GetRow(i)
		if isCutline(row) {
			cutLines = append(cutLines, i)
		}
	}

	if len(cutLines) == 0 {
		// 如果没有找到切割线，返回原图作为唯一页面
		return []*RasterImage{img}
	}

	for line := range cutLines {
		start := 0
		if line > 0 {
			start = cutLines[line-1] + 1
		}
		end := cutLines[line]
		if end > start {
			pages = append(pages, img.SelectRows(start, end).Copy())
		}
	}

	// 处理最后一段（如果最后一行不是cutline）
	lastCut := cutLines[len(cutLines)-1] + 1
	if lastCut < img.Height {
		pages = append(pages, img.SelectRows(lastCut, img.Height).Copy())
	}

	return pages
}
